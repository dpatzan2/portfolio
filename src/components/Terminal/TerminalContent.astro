---
// Terminal Content Component - Simula una terminal Linux bÃ¡sica
import { profileData } from '../../data/profile';
---

<div class="terminal-container h-full flex flex-col bg-[#300a24] font-mono text-sm">
  <!-- Terminal Output -->
  <div id="terminal-output" class="flex-1 p-4 overflow-y-auto">
    <!-- Welcome Message -->
    <pre class="text-[#E95420] mb-4">
 ____  ____       _                  
|  _ \|  _ \ __ _| |_ ______ _ _ __  
| | | | |_) / _` | __|_  / _` | '_ \ 
| |_| |  __/ (_| | |_ / / (_| | | | |
|____/|_|   \__,_|\__/___\__,_|_| |_|
    </pre>
    <div class="text-green-400 mb-2">Â¡Bienvenido a la terminal de DPatzÃ¡n Portfolio!</div>
    <div class="text-gray-400 mb-4">Escribe 'help' para ver los comandos disponibles.</div>
  </div>
  
  <!-- Terminal Input -->
  <div class="flex items-center p-2 border-t border-white/10 bg-[#2c001e]">
    <span class="text-green-400 mr-2">guest@dpatzan:~$</span>
    <input 
      type="text" 
      id="terminal-input"
      class="flex-1 bg-transparent text-white outline-none caret-green-400"
      autocomplete="off"
      spellcheck="false"
      autofocus
    />
  </div>
</div>

<script define:vars={{ profileData }}>
  // Terminal State
  const commandHistory = [];
  let historyIndex = -1;
  let currentPath = '/home/guest';
  
  // DOM Elements
  const output = document.getElementById('terminal-output');
  const input = document.getElementById('terminal-input');
  const promptElement = document.querySelector('.terminal-container .text-green-400');
  
  // Virtual File System - Tree structure
  const fileSystem = {
    '/': {
      type: 'dir',
      children: {
        'home': {
          type: 'dir',
          children: {
            'guest': {
              type: 'dir',
              children: {
                'about.txt': {
                  type: 'file',
                  content: `Nombre: ${profileData.name}
CarnÃ©: ${profileData.carne}
Email: ${profileData.email}

${profileData.description.join('\n')}`
                },
                'skills.txt': {
                  type: 'file',
                  content: `=== Habilidades TÃ©cnicas ===
${profileData.skills.map(s => `â€¢ ${s.name}`).join('\n')}

=== Soft Skills ===
${profileData.softSkills.join(', ')}`
                },
                'contact.txt': {
                  type: 'file',
                  content: `ðŸ“§ Email: ${profileData.email}
ðŸŽ“ CarnÃ©: ${profileData.carne}
ðŸ« Universidad del Valle de Guatemala`
                },
                'projects': {
                  type: 'dir',
                  children: {
                    'README.md': {
                      type: 'file',
                      content: `# Proyectos
AquÃ­ encontrarÃ¡s mis proyectos mÃ¡s destacados.
Visita la ventana de Proyectos para mÃ¡s detalles.`
                    },
                    'portfolio': {
                      type: 'dir',
                      children: {
                        'info.txt': {
                          type: 'file',
                          content: 'Portfolio Ubuntu - Construido con Astro y TailwindCSS'
                        }
                      }
                    }
                  }
                },
                'documents': {
                  type: 'dir',
                  children: {
                    'cv.pdf': {
                      type: 'file',
                      content: '[Archivo PDF - Usa el visor de documentos para ver el CV]'
                    }
                  }
                },
                'downloads': {
                  type: 'dir',
                  children: {}
                }
              }
            }
          }
        }
      }
    }
  };

  // Helper: Get node from path
  function getNode(path) {
    if (path === '/') return fileSystem['/'];
    
    const parts = path.split('/').filter(p => p);
    let node = fileSystem['/'];
    
    for (const part of parts) {
      if (!node.children || !node.children[part]) {
        return null;
      }
      node = node.children[part];
    }
    return node;
  }

  // Helper: Resolve path (handle .., ., ~, relative paths)
  function resolvePath(pathArg) {
    let path = pathArg;
    
    // Handle home shortcut
    if (path === '~' || path.startsWith('~/')) {
      path = '/home/guest' + path.slice(1);
    }
    
    // Handle absolute vs relative
    if (!path.startsWith('/')) {
      path = currentPath + '/' + path;
    }
    
    // Normalize path (resolve . and ..)
    const parts = path.split('/').filter(p => p);
    const resolved = [];
    
    for (const part of parts) {
      if (part === '..') {
        resolved.pop();
      } else if (part !== '.') {
        resolved.push(part);
      }
    }
    
    return '/' + resolved.join('/');
  }

  // Helper: Get display path (shorten /home/guest to ~)
  function getDisplayPath(path) {
    if (path === '/home/guest') return '~';
    if (path.startsWith('/home/guest/')) return '~' + path.slice(11);
    return path;
  }

  // Update prompt
  function updatePrompt() {
    if (promptElement) {
      promptElement.textContent = `guest@dpatzan:${getDisplayPath(currentPath)}$ `;
    }
  }
  
  // Commands
  const commands = {
    help: () => `Comandos disponibles:
  help        - Muestra esta ayuda
  whoami      - Muestra el usuario actual
  pwd         - Muestra el directorio actual
  cd [dir]    - Cambia de directorio
  ls [dir]    - Lista archivos y directorios
  cat [file]  - Muestra el contenido de un archivo
  clear       - Limpia la terminal
  date        - Muestra la fecha actual
  echo [text] - Imprime texto
  neofetch    - Muestra informaciÃ³n del sistema
  history     - Muestra historial de comandos
  cd [dir]    - Cambia de directorio`,
    
    whoami: () => 'guest',
    
    pwd: () => currentPath,
    
    cd: (args) => {
      const target = args && args.length > 0 ? args[0] : '~';
      const newPath = resolvePath(target);
      const node = getNode(newPath);
      
      if (!node) {
        return `<span class="text-red-400">cd: ${target}: No existe el directorio</span>`;
      }
      if (node.type !== 'dir') {
        return `<span class="text-red-400">cd: ${target}: No es un directorio</span>`;
      }
      
      currentPath = newPath || '/';
      updatePrompt();
      
      // Visual confirmation of directory change
      const displayPath = getDisplayPath(currentPath);
      const itemCount = Object.keys(node.children || {}).length;
      return `<span class="text-cyan-400">ðŸ“‚ ${displayPath}</span> <span class="text-gray-500">(${itemCount} elemento${itemCount !== 1 ? 's' : ''})</span>`;
    },
    
    ls: (args) => {
      const target = args && args.length > 0 ? resolvePath(args[0]) : currentPath;
      const node = getNode(target);
      
      if (!node) {
        return `<span class="text-red-400">ls: ${args[0]}: No existe el directorio</span>`;
      }
      if (node.type !== 'dir') {
        return `<span class="text-white">${args[0]}</span>`;
      }
      
      const entries = Object.keys(node.children || {});
      if (entries.length === 0) {
        return '<span class="text-gray-500">(directorio vacÃ­o)</span>';
      }
      
      return entries.map(name => {
        const child = node.children[name];
        if (child.type === 'dir') {
          return `<span class="text-blue-400">${name}/</span>`;
        }
        return `<span class="text-white">${name}</span>`;
      }).join('  ');
    },
    
    cat: (args) => {
      if (!args || args.length === 0) {
        return '<span class="text-red-400">cat: falta el operando archivo</span>';
      }
      
      const target = resolvePath(args[0]);
      const node = getNode(target);
      
      if (!node) {
        return `<span class="text-red-400">cat: ${args[0]}: No existe el archivo o directorio</span>`;
      }
      if (node.type === 'dir') {
        return `<span class="text-red-400">cat: ${args[0]}: Es un directorio</span>`;
      }
      
      return node.content;
    },
    
    clear: () => {
      output.innerHTML = '';
      return null;
    },
    
    date: () => new Date().toLocaleString('es-GT', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }),
    
    echo: (args) => args ? args.join(' ') : '',
    
    neofetch: () => `<span class="text-[#E95420]">       _,met$$$$$gg.           </span><span class="text-white">guest@dpatzan</span>
<span class="text-[#E95420]">    ,g$$$$$$$$$$$$$$$P.        </span><span class="text-white">--------------</span>
<span class="text-[#E95420]">  ,g$$P""       """Y$$.".      </span><span class="text-[#E95420]">OS:</span> Ubuntu Portfolio 24.04 LTS
<span class="text-[#E95420]"> ,$$P'              \`$$$.     </span><span class="text-[#E95420]">Host:</span> ${profileData.name}
<span class="text-[#E95420]">',$$P       ,ggs.     \`$$b:   </span><span class="text-[#E95420]">Kernel:</span> Astro 5.x
<span class="text-[#E95420]">\`d$$'     ,$P"'   .    $$$    </span><span class="text-[#E95420]">Uptime:</span> ${Math.floor(Math.random() * 30) + 1} dÃ­as
<span class="text-[#E95420]"> $$P      d$'     ,    $$P    </span><span class="text-[#E95420]">Shell:</span> bash 5.1.16
<span class="text-[#E95420]"> $$:      $$.   -    ,d$$'    </span><span class="text-[#E95420]">Terminal:</span> portfolio-term
<span class="text-[#E95420]"> $$;      Y$b._   _,d$P'      </span><span class="text-[#E95420]">CPU:</span> JavaScript Engine @ 100%
<span class="text-[#E95420]"> Y$$.    \`.\`"Y$$$$P"'         </span><span class="text-[#E95420]">Memory:</span> 1337MB / âˆžMB
<span class="text-[#E95420]"> \`$$b      "-.__              </span><span class="text-[#E95420]">Skills:</span> ${profileData.skills.length} tecnologÃ­as
<span class="text-[#E95420]">  \`Y$$                        </span>
<span class="text-[#E95420]">   \`Y$$.                      </span><span style="background:#E95420" class="px-2">  </span><span style="background:#77216F" class="px-2">  </span><span style="background:#5E2750" class="px-2">  </span><span style="background:#2C001E" class="px-2">  </span>
<span class="text-[#E95420]">     \`$$b.                    </span>
<span class="text-[#E95420]">       \`Y$$b.                 </span>
<span class="text-[#E95420]">          \`"Y$b._             </span>`,
    
    history: () => {
      if (commandHistory.length === 0) return 'Historial vacÃ­o';
      return commandHistory.map((cmd, i) => `  ${i + 1}  ${cmd}`).join('\n');
    },
    
    mkdir: (args) => {
      if (!args || args.length === 0) {
        return '<span class="text-red-400">mkdir: falta el operando</span>';
      }
      return `<span class="text-yellow-400">mkdir: OperaciÃ³n no permitida - Este portfolio es de solo lectura</span>`;
    },
    
    touch: (args) => {
      return `<span class="text-yellow-400">touch: OperaciÃ³n no permitida - Este portfolio es de solo lectura</span>`;
    },
    
    sudo: () => `<span class="text-red-400">sudo: No tienes permisos de superusuario en este portfolio ðŸ˜„</span>`,
    
    rm: () => `<span class="text-red-400">rm: OperaciÃ³n no permitida - Este portfolio es de solo lectura</span>`,
    
    exit: () => {
      addOutput('<span class="text-yellow-400">Â¡Hasta pronto! Cierra la ventana para salir.</span>');
      return null;
    }
  };
  
  // Add output line
  function addOutput(html, isCommand = false) {
    if (html === null) return;
    const div = document.createElement('div');
    div.className = isCommand ? 'text-white mb-1' : 'mb-2 whitespace-pre-wrap';
    div.innerHTML = html;
    output.appendChild(div);
    output.scrollTop = output.scrollHeight;
  }
  
  // Process command
  function processCommand(cmdLine) {
    const trimmed = cmdLine.trim();
    if (!trimmed) return;
    
    // Add to history
    commandHistory.push(trimmed);
    historyIndex = commandHistory.length;
    
    // Show command with current path
    addOutput(`<span class="text-green-400">guest@dpatzan:${getDisplayPath(currentPath)}$</span> ${trimmed}`, true);
    
    // Parse command
    const parts = trimmed.split(/\s+/);
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);
    
    // Execute
    if (commands[cmd]) {
      const result = commands[cmd](args);
      if (result !== null) {
        addOutput(result);
      }
    } else {
      addOutput(`<span class="text-red-400">${cmd}: comando no encontrado. Escribe 'help' para ver comandos disponibles.</span>`);
    }
  }
  
  // Event listeners
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      processCommand(input.value);
      input.value = '';
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (historyIndex > 0) {
        historyIndex--;
        input.value = commandHistory[historyIndex];
      }
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (historyIndex < commandHistory.length - 1) {
        historyIndex++;
        input.value = commandHistory[historyIndex];
      } else {
        historyIndex = commandHistory.length;
        input.value = '';
      }
    } else if (e.key === 'l' && e.ctrlKey) {
      e.preventDefault();
      commands.clear();
    }
  });
  
  // Focus input when clicking on terminal
  document.querySelector('.terminal-container').addEventListener('click', () => {
    input.focus();
  });
</script>

<style>
  .terminal-container {
    font-family: 'Ubuntu Mono', 'Fira Code', 'Consolas', monospace;
  }
  
  #terminal-output::-webkit-scrollbar {
    width: 8px;
  }
  
  #terminal-output::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
  }
  
  #terminal-output::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }
  
  #terminal-output::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  pre {
    font-size: 10px;
    line-height: 1.2;
  }
  
  @media (min-width: 768px) {
    pre {
      font-size: 12px;
    }
  }
</style>
